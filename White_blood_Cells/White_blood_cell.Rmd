---
title: "White Blood Cell Classification"
date: '`r Sys.Date()`'
output:
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    fig_width: 7
    fig_height: 6
    theme: cosmo
    highlight: tango
    code_folding: show #hide
    self_contained: no
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo=TRUE, error=FALSE)
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```

# Introduction
Medical Image Analysis is a widely used method to screen and diagnose diseases. Depending of the part or tissue of the body would check, we can subset imaging Technics into 2 big methods. First the methods that use rays, like x-ray, Nuclear Magnetic Resonance (NMR) or Scintigraphy. In general, the images generated by these methods are as a photographic film (black and white). The advantage of these methods is that we can observe body through tissues and have access to internal parts without chirurgy. The inconvenient is that these methods uses ionizing radiation (dangerous for health) and mainly expensive. There are at less two kaggle competition with this type of images: [NIH Chest X-rays](https://www.kaggle.com/nih-chest-xrays/data) and [Chest X-Ray Images (Pneumonia)](https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia)
The second kind of medical imaging is applied to all type of tissues or physiological fluid (plasma, blood). The samples are prepared on glass slide and stained with Hematoxylin and eosin stain [(H&E)](https://en.wikipedia.org/wiki/H%26E_stain). This technique is very old and widely used for several medical screening and diagnostics. H&E staining is not expensive but needs Human intervention and the processing takes a while. The interpretation of the images also needs multiple experts (pathologist) to visualize and diagnose slides mainly through microscopes. the analysis remains subjective and could differ between pathologists.

On the other hand, the H&E stains are routinely prepared by technicians who become overwhelmed by the increasing number of samples. Likewise, pathologists are over-worked by the microscopic observation and interpretation, causing overflow that may result in diagnostic error.

## Motivation
A computational grading of slides using learning machine may help to make a pre-screening a hundred or thousand or slides before Human verification.

## load package

```{r include=FALSE, echo=FALSE}
library(EBImage)
library(XML)
library(dplyr)
library(tidyr)
```

## Dataset description
The images of this competition shows blood cell spread on glass slide and stained by H&E method. We can visualize red blood cell and immune cells. It is easy to make a difference between these two kind of cells. The coloration is not the same, red cells are red but immune cell are purple.  

### Glimpse of digital slide
```{r fig.width=7, fig.height=7}
library(EBImage)
path_to_dataset <- "dataset-master/JPEGImages/"
img <- readImage(paste0(path_to_dataset, "BloodImage_00000.jpg"))
img_resize = resize(img, w=128, h=128)

par(mfrow=c(1,2)) # , mai=c(0.1,0.1,0.2,0.1), oma=c(3,3,3,3)
plot(img_resize)
title( main = "plot function")
display(img_resize, method = "raster", all = TRUE, margin = 1)
title( main = "display function")
```

* We observe one purple cell which is a white blood cell. The other cells are read blood cell.

* There are 4 types of immune cells, named also White Blood Cells (WBC). 

### Glimpse of the 4  White Blood Cell types
```{r}
path_to_dataset2 <- "dataset2-master/images/TEST_SIMPLE/"
img_eosinophil <- readImage(paste0(path_to_dataset2, "EOSINOPHIL/_0_5239.jpeg"))
img_lymphocyte <- readImage(paste0(path_to_dataset2, "LYMPHOCYTE/_0_3975.jpeg")) 
img_monocyte <- readImage(paste0(path_to_dataset2, "MONOCYTE/_0_5020.jpeg")) 
img_neutrophil <- readImage(paste0(path_to_dataset2, "NEUTROPHIL/_0_1966.jpeg")) 
par(mfrow=c(2,2))
graphics::plot(img_eosinophil)
title(main = "EOSINOPHIL white cell")
plot(img_lymphocyte)
title(main = "LYMPHOCUTE white cell")
plot(img_monocyte)
title(main = "MONOCYTE white cell")
plot(img_neutrophil)
title(main = "NEUTROPHIL white cell")

```

## Description of the First Dataset
The first dataset directory names `dataset-master` contains 3 folders:

* JPEGImages that has 366 jpeg images
* csv file that list the image label and the white cell type that has.
* XML annotation folder that frame the different kind of cells in each image (343 XML files).
    + Green square for red blood cell (RB)
    + Red square for white blood cell (WBC)
    + Blue square for Platelets

Example of image with annotation:
[![link to image](https://github.com/Shenggan/BCCD_Dataset/blob/master/example.jpg)](https://github.com/Shenggan/BCCD_Dataset/blob/master/example.jpg)  

## Exploration and Transformation of the first dataset

### Transformation of `labels.csv` file
Labels associate cells type. We can find Red Blood Cell (RBC), Platelets, and 4 types of White Bolld Cells (WBC). 

We renamed images as its files names. Some image have two kind of WBC. 

We need to crop each cell from image and rang it to associated category.  
```{r}
# glimpse csv file
path_to_csv <- "dataset-master/labels.csv"
label <- read.csv(file = path_to_csv)

# Rename images like files
WBC_seprate_multiple_label <- label %>%
  mutate(file_name = case_when(
           Image %in% 0:9 ~ paste0("BloodImage_0000", Image), 
           Image %in% 10:99 ~ paste0("BloodImage_000", Image),        
           Image %in% 100:999 ~ paste0("BloodImage_00", Image),
                  TRUE                    ~ "huh?"
           ))%>%
 select(file_name, Image, Category) %>%
  # Separate categories in the same image
 tidyr::separate_rows(Category)

# Rename differently the cropped cells from the same image
# This step is essential when we woulf join labels with annotations
WBC_seprate_multiple_label <-
WBC_seprate_multiple_label %>% group_by(file_name) %>%
       mutate(new_file_name = if(n( ) > 1) {paste0(file_name,"_" , row_number( ))} 
                             else {paste0(file_name)})

WBC_seprate_multiple_label
```

```{r}
dplyr::glimpse(WBC_seprate_multiple_label )
# glimpse image name 
dplyr::glimpse(list.files("dataset-master/JPEGImages/"))
```

* **NB: there is no the same number of labels (441) and images (366)**
* **There is 426 - 411 images with multiple WBC**

### Explore and Transform XML file
```{r}
Path_to_xml_file_9 <- "dataset-master/Annotations/BloodImage_00009.xml"
xml9 <- XML::xmlParse(Path_to_xml_file_9)
xml_df <- XML::xmlToDataFrame(Path_to_xml_file_9)
DT::datatable(xml_df)
#print(xml_df[['bndbox']])
```
We converted an example of xml file to dataframe. We find intersting information about the x,y coordinates of cells.

* `bndbox` column show the x and y limits of the annotations. We need to extract xmin, ymin, xmax, and ymax.

* `name` column indicates the type of cells.

Here the coordonate of multiple RBC are poorly represented. We observe a cancatenation of 4 coordinates: xmin, xmax, ymin, ymax.

I opened multiple xml file and I did not finf WBC cell with its x, y limits. 

You can use `extract_square_of_WBC("dataset-master/Annotations/BloodImage_00019.xml")` function and change the name of the image. 

The output does not have WCB sample. In actual document the code was run with the dataset download from github.


* **I replaced Dataset-master/Annotations  and Dataset_master/JPEGImages  from github**

[link to github](https://github.com/Shenggan/BCCD_Dataset/tree/master/BCCD)

* **At first view it seems updated and xml files have WBC annotations wich it is not available for kaggle dataset version**

### Function to extract x, y limits of WBC from xml files
```{r}
# Extract annotation of cell  as dataframe (square limits)
extract_square_of_WBC <- function(file_path){
xml_obj <- XML::xmlParse(file_path)

xml_obj_df <- bind_cols(  # or cbind()
## print the name of cell
xmlToDataFrame(getNodeSet(xml_obj, "//name"),stringsAsFactors = TRUE),
# print dimension
xmlToDataFrame(getNodeSet(xml_obj, "//object/bndbox"), stringsAsFactors = FALSE)
)

xml_obj_df %>%
  rename( "Cells" = text) %>%
  mutate(xmin = as.numeric(xmin)) %>%
  mutate(ymin = as.numeric(ymin)) %>%
  mutate(xmax = as.numeric(xmax)) %>%
  mutate(ymax = as.numeric(ymax)) %>%
  filter(Cells == "WBC") %>%
  mutate(file_name = basename(file_path))
}
extract_square_of_WBC("dataset-master/Annotations/BloodImage_00019.xml")
```

### Group all x, y limits of WBC into dataframe
```{r}
## get all squares of WBC cell for all images
Path_to_xml_file_list <- list.files("dataset-master/Annotations",full.names = TRUE)
ls_df <- lapply(Path_to_xml_file_list, function(x) extract_square_of_WBC(x))
xy_limits_WCB <- do.call("rbind",ls_df)

DT::datatable(xy_limits_WCB)
```

* Mainly we have one WBC for each image BUT some image have two type of WBC. for example image 10 has two WCB.

In the next step we need to add aannotation or type of each WBC. The annotation is transformed csv file `WBC_seprate_multiple_label`.

### Explore only image with multiple WBC
```{r}
## Explore only image with multiple WBC
only_image_multiple_WBC <- 
  WBC_seprate_multiple_label[duplicated(WBC_seprate_multiple_label$file_name, fromLast = FALSE) |
                               duplicated(WBC_seprate_multiple_label$file_name, fromLast = TRUE),] 

only_image_multiple_WBC
```

### Merge all needed informations of images with multiple WBC into dataframe
```{r}
## Merge all needed informations of images with multiple WBC into dataframe

path_to_images <- "dataset-master/JPEGImages/"

crops_WBC_df  <-
  xy_limits_WCB %>%
  mutate(file_name = gsub(".xml", "", file_name)) %>%
  group_by(file_name) %>%
       mutate(new_file_name = if(n( ) > 1) {paste0(file_name, "_" ,row_number( ))} 
                            else {paste0(file_name)}) %>%
  ungroup() %>%
  select(-file_name) %>%
  left_join(only_image_multiple_WBC , by = "new_file_name") %>%
  drop_na() %>%
  mutate(file_path = paste0(path_to_dataset, file_name, ".jpg"))

DT::datatable(crops_WBC_df)
```


### Function to plot cropped WBC from images
```{r fig.width=2, fig.height=2}
# multiple plot of crops
multiple_plot_crops <- function(df){
  l <- nrow(df)
  for(i in 1:l){
    attach(df)
  img <- EBImage::readImage(file_path[i])
  par(mfrow=c(1,2))
   plot(img)
   title(main= paste0("Img.",Image[i]), cex.main = 0.5, cex.sub = 0.75)
   plot(img[xmin[i] : xmax[i], ymin[i] : ymax[i],])
   title(main = Category[i], cex.main = 0.5, cex.sub = 0.75)
   detach(df)
  }
}


 
 
# l <- nrow(crops_WBC_df)
# par(mfrow = c(l,1))
multiple_plot_crops(crops_WBC_df)


```


We find:
The crps seems to be well done. Now we will crop all WBC type and generate our primary dataset with unicellular images.

### Merge all needed informations of all images in dataset-master into dataframe

```{r}
# we need: `xy_limits_WCB` and `WBC_seprate_multiple_label` dataframes

path_to_images <- "dataset-master/JPEGImages/"

all_crops_WBC_df  <-
  xy_limits_WCB %>%
  mutate(file_name = gsub(".xml", "", file_name)) %>%
  group_by(file_name) %>%
       mutate(new_file_name = if(n( ) > 1) {paste0(file_name, "_" ,row_number( ))} 
                            else {paste0(file_name)}) %>%
  ungroup() %>%
  select(-file_name) %>%
  left_join(WBC_seprate_multiple_label , by = "new_file_name") %>%
  drop_na() %>%
  mutate(file_path = paste0(path_to_dataset, file_name, ".jpg"))
```




## Description of the second dataset  
The second dataset directory named `dataset2-master` contains image folder for each class of WBC and csv file that label images.


